<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SEA 수리&재가공 현황 (실시간 Firestore 연동)</title>
<style>
  * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  body { background: #f5f7fa; margin: 0; padding: 20px; }
  .container { max-width: 2000px; margin: 0 auto; }
  .header { text-align: center; padding: 20px; margin-bottom: 18px;
            border-radius: 15px; color:#fff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 8px 32px rgba(0,0,0,.1); }
  .header h1 { margin: 0; font-size: 2.1rem; font-weight: 800; letter-spacing: .02em; }

  .controls { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:16px; }
  .btn { padding: 10px 16px; border:0; border-radius:8px; color:#fff; cursor:pointer; font-weight:700;
         box-shadow: 0 4px 14px rgba(0,0,0,.12); }
  .btn-add { background: linear-gradient(135deg, #4CAF50, #45a049); }
  .btn-del { background: linear-gradient(135deg, #f44336, #da190b); }
  .btn-reg { background: linear-gradient(135deg, #2196F3, #1976D2); }

  .table-container { background:#fff; border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,.08); overflow:hidden; }
  table { width: 100%; border-collapse: collapse; table-layout: auto; }
  th, td { border:1px solid #e0e0e0; text-align:center; padding:10px 6px; }
  thead th { position: sticky; top:0; z-index:10; color:#fff;
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  tr:nth-child(even) { background:#fafafa; }
  tr:hover { background:#f1f6ff; }

  input[type="date"], select { width:100%; padding:6px 8px; border:1px solid #ddd; border-radius:6px; font-size:.9rem; }
  .filter-input { width: 100%; padding: 5px 6px; border:1px solid #ddd; border-radius:6px; margin-top:6px; font-size:.8rem; }

  [contenteditable] { padding:6px; min-height:24px; border:1px solid transparent; border-radius:6px; }
  [contenteditable]:hover { border-color:#e3e3e3; }
  [contenteditable]:focus { outline:0; border-color:#2196F3; background:#fff3e0; }

  /* 너비 튜닝 */
  #mainTable th:nth-child(4),  #mainTable td:nth-child(4)  { min-width: 100px; } /* 거래처 */
  #mainTable th:nth-child(5),  #mainTable td:nth-child(5)  { min-width: 100px; } /* 품번 */
  #mainTable th:nth-child(6),  #mainTable td:nth-child(6)  { min-width: 100px; } /* 품명 */
  #mainTable th:nth-child(7),  #mainTable td:nth-child(7)  { min-width: 130px; } /* 규격 */
  #mainTable th:nth-child(10), #mainTable td:nth-child(10) { min-width: 160px; } /* 상태 */
  #mainTable th:nth-child(11), #mainTable td:nth-child(11) { min-width: 60px; }  /* 수리담당자 */
  #mainTable th:nth-child(12), #mainTable td:nth-child(12) { min-width: 100px; } /* 연락처 */
  #mainTable th:nth-child(14), #mainTable td:nth-child(14) { min-width: 60px; }  /* 수리비용 */
  #mainTable th:nth-child(15), #mainTable td:nth-child(15) { min-width: 100px; } /* 비고 */

  /* 모달 */
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:999; }
  .modal-content { width: 420px; max-width: calc(100vw - 40px); margin: 5% auto; background:#fff; border-radius:12px;
                   padding: 16px; box-shadow:0 20px 60px rgba(0,0,0,.3); }
  .modal-header { text-align:center; font-weight:800; margin-bottom:12px; }
  .modal-table { width:100%; border-collapse: collapse; table-layout: fixed; }
  .modal-table th, .modal-table td { border:1px solid #eee; padding:6px 8px; font-size:.9rem; text-align:center; }
  .modal-table th { width: 110px; background:#fafafa; }
  .modal-input { width: 100%; padding:6px 8px; border:1px solid #ddd; border-radius:6px; }
  .modal-footer { text-align:center; margin-top:10px; }
  .modal-btn { padding:9px 16px; border:0; border-radius:6px; cursor:pointer; color:#fff; font-weight:700; }
  .ok { background: linear-gradient(135deg, #4CAF50, #45a049); }
  .cancel { background: linear-gradient(135deg, #f44336, #da190b); margin-left:6px; }
</style>
</head>
<body>
<div class="container">
  <div class="header"><h1>SEA 수리&재가공 현황</h1></div>

  <div class="controls">
    <button class="btn btn-add" id="btnAdd">[행 추가]</button>
    <button class="btn btn-del" id="btnDelete">[행 삭제]</button>
    <button class="btn btn-reg" id="btnOpen">[접수]</button>
  </div>

  <div class="table-container">
    <table id="mainTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="checkAll" /></th>
          <th>접수일자<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(1,this.value)" /></th>
          <th>발송일자<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(2,this.value)" /></th>
          <th>거래처<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(3,this.value)" /></th>
          <th>품번<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(4,this.value)" /></th>
          <th>품명<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(5,this.value)" /></th>
          <th>규격<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(6,this.value)" /></th>
          <th>증상<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(7,this.value)" /></th>
          <th>진단 결과<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(8,this.value)" /></th>
          <th>상태<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(9,this.value)" /></th>
          <th>수리 담당자<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(10,this.value)" /></th>
          <th>연락처<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(11,this.value)" /></th>
          <th>수리완료일<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(12,this.value)" /></th>
          <th>수리비용<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(13,this.value)" /></th>
          <th>비고<br/><input class="filter-input" placeholder="필터" onkeyup="filterTable(14,this.value)" /></th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- 실시간으로 Firestore 문서를 렌더링합니다 -->
      </tbody>
    </table>
  </div>
</div>

<!-- 접수 모달 -->
<div id="registerModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h2 class="modal-header">신규 접수 등록</h2>
    <table class="modal-table">
      <tr><th>접수일자</th><td><input id="mReceipt" type="date" class="modal-input" /></td></tr>
      <tr><th>거래처</th><td><input id="mCompany" type="text" class="modal-input" maxlength="50" /></td></tr>
      <tr><th>품번</th><td><input id="mPartNo" type="text" class="modal-input" maxlength="50" /></td></tr>
      <tr><th>품명</th><td><input id="mPartName" type="text" class="modal-input" maxlength="100" /></td></tr>
      <tr><th>규격</th><td><input id="mSpec" type="text" class="modal-input" maxlength="100" /></td></tr>
      <tr><th>증상</th><td><input id="mSymptom" type="text" class="modal-input" maxlength="200" /></td></tr>
      <tr><th>담당자</th><td><input id="mRepairer" type="text" class="modal-input" maxlength="50" /></td></tr>
      <tr><th>연락처</th><td><input id="mContact" type="text" class="modal-input" maxlength="50" /></td></tr>
      <tr><th>비고</th><td><input id="mNote" type="text" class="modal-input" maxlength="300" /></td></tr>
    </table>
    <div class="modal-footer">
      <button class="modal-btn ok" id="mOk">[확인]</button>
      <button class="modal-btn cancel" id="mCancel">[취소]</button>
    </div>
  </div>
</div>

<script type="module">
/* =========================
   Firebase 초기화 & Firestore
   ========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// TODO: 여기에 본인 Firebase 설정을 붙여 넣으세요 (Firebase 콘솔 > 프로젝트 설정 > 일반 > 내 앱 > 구성)
const firebaseConfig = {
  apiKey: "AIzaSyDu8Vndai1pzgxehi-JC2RKaGyOJpiJJXo",
  authDomain: "searepair-a8528.firebaseapp.com",
  projectId: "searepair-a8528",
  storageBucket: "searepair-a8528.firebasestorage.app",
  messagingSenderId: "274727078627",
  appId: "1:274727078627:web:6f857f5e3ce6f1ab1613d6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// 오프라인 캐시(선택)
enableIndexedDbPersistence(db).catch(() => { /* 탭이 많으면 실패할 수 있음 - 무시 가능 */ });

/* ===============
   DOM 셋업
   =============== */
const tbody = document.getElementById("tableBody");
const checkAll = document.getElementById("checkAll");
const btnAdd = document.getElementById("btnAdd");
const btnDelete = document.getElementById("btnDelete");
const btnOpen = document.getElementById("btnOpen");
const modal = document.getElementById("registerModal");
const mOk = document.getElementById("mOk");
const mCancel = document.getElementById("mCancel");

checkAll.addEventListener("change", () => {
  document.querySelectorAll(".rowCheck").forEach(cb => cb.checked = checkAll.checked);
});

// 컬럼 키 매핑 (th 순서 기준)
const COL_KEYS = [
  "_check",          // 0 (체크박스)
  "receiptDate",     // 1
  "shipDate",        // 2
  "company",         // 3
  "partNo",          // 4
  "partName",        // 5
  "spec",            // 6
  "symptom",         // 7
  "diagnosis",       // 8
  "status",          // 9 (select)
  "repairer",        //10
  "contact",         //11
  "completeDate",    //12
  "cost",            //13
  "note"             //14
];

/* ===============
   유틸
   =============== */
const debounce = (fn, ms=400) => {
  let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
};
const numOrStr = v => v == null ? "" : String(v);

/* ===============
   행 렌더링
   =============== */
function createRowHTML() {
  return `
    <td><input type="checkbox" class="rowCheck" /></td>
    <td><input type="date" data-key="receiptDate"/></td>
    <td><input type="date" data-key="shipDate"/></td>
    <td contenteditable="true" data-key="company"></td>
    <td contenteditable="true" data-key="partNo"></td>
    <td contenteditable="true" data-key="partName"></td>
    <td contenteditable="true" data-key="spec"></td>
    <td contenteditable="true" data-key="symptom"></td>
    <td contenteditable="true" data-key="diagnosis"></td>
    <td>
      <select data-key="status">
        <option value="">선택</option>
        <option value="접수완료">접수완료</option>
        <option value="수리중">수리 중</option>
        <option value="무상수리완료">무상수리완료</option>
        <option value="유상수리완료">유상수리완료</option>
      </select>
    </td>
    <td contenteditable="true" data-key="repairer"></td>
    <td contenteditable="true" data-key="contact"></td>
    <td><input type="date" data-key="completeDate"/></td>
    <td contenteditable="true" data-key="cost"></td>
    <td contenteditable="true" data-key="note"></td>
  `;
}

function applyDataToRow(tr, data) {
  Array.from(tr.cells).forEach((cell, idx) => {
    const key = COL_KEYS[idx];
    if (key === "_check") return;
    const input = cell.querySelector("input");
    const sel = cell.querySelector("select");
    if (input) input.value = numOrStr(data[key] || "");
    else if (sel) sel.value = numOrStr(data[key] || "");
    else cell.innerText = numOrStr(data[key] || "");
  });
}

/* ===============
   Firestore CRUD
   =============== */
const colRef = collection(db, "seaRows");

async function addRowDoc(prefill={}) {
  const base = {
    receiptDate: prefill.receipt || "",
    shipDate: "",
    company: prefill.company || "",
    partNo: prefill.partNo || "",
    partName: prefill.partName || "",
    spec: prefill.spec || "",
    symptom: prefill.symptom || "",
    diagnosis: "",
    status: "",
    repairer: prefill.repairer || "",
    contact: prefill.contact || "",
    completeDate: "",
    cost: "",
    note: prefill.note || "",
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp(),
    authorUid: (auth.currentUser && auth.currentUser.uid) || null
  };
  await addDoc(colRef, base);
}

async function deleteSelectedRows() {
  const selected = Array.from(tbody.querySelectorAll("tr"))
    .filter(tr => tr.querySelector(".rowCheck")?.checked)
    .map(tr => tr.dataset.id);
  await Promise.all(selected.map(id => deleteDoc(doc(db, "seaRows", id))));
}

/* ===============
   이벤트 바인딩(한 행)
   =============== */
function attachRowListeners(tr) {
  // input, select는 change로 저장 / contenteditable은 blur로 저장 (디바운스)
  const handler = debounce(async (target) => {
    const key = target.dataset.key;
    if (!key) return;
    const id = tr.dataset.id;
    const value = target.tagName === "INPUT" || target.tagName === "SELECT"
      ? target.value
      : target.innerText;
    await updateDoc(doc(db, "seaRows", id), { [key]: value, updatedAt: serverTimestamp() });
  }, 300);

  tr.querySelectorAll("input[data-key], select[data-key]").forEach(el => {
    el.addEventListener("change", e => handler(e.target));
  });
  tr.querySelectorAll("[contenteditable][data-key]").forEach(el => {
    el.addEventListener("blur", e => handler(e.target));
  });
}

/* ===============
   실시간 구독
   =============== */
function startRealtime() {
  const qy = query(colRef, orderBy("createdAt", "asc"));
  onSnapshot(qy, (snap) => {
    const existing = new Map(Array.from(tbody.querySelectorAll("tr")).map(tr => [tr.dataset.id, tr]));
    snap.docChanges().forEach(change => {
      const id = change.doc.id;
      const data = change.doc.data();
      if (change.type === "added") {
        if (existing.has(id)) return; // 이미 있음
        const tr = document.createElement("tr");
        tr.dataset.id = id;
        tr.innerHTML = createRowHTML();
        applyDataToRow(tr, data);
        tbody.appendChild(tr);
        attachRowListeners(tr);
      } else if (change.type === "modified") {
        const tr = existing.get(id);
        if (tr) applyDataToRow(tr, data);
      } else if (change.type === "removed") {
        const tr = existing.get(id);
        if (tr) tr.remove();
      }
    });
  });
}

/* ===============
   필터 (헤더 input onkeyup가 호출)
   =============== */
window.filterTable = function(colIndex, term) {
  const rows = tbody.querySelectorAll("tr");
  const q = (term || "").toLowerCase();
  rows.forEach(r => {
    const cell = r.cells[colIndex];
    const text = cell ? (cell.innerText || cell.textContent || "").toLowerCase() : "";
    r.style.display = text.indexOf(q) > -1 ? "" : "none";
  });
};

/* ===============
   모달
   =============== */
function openModal() {
  modal.style.display = "block";
  document.body.style.overflow = "hidden";
  modal.querySelectorAll("input").forEach(i => i.value = "");
}
function closeModal() {
  modal.style.display = "none";
  document.body.style.overflow = "";
}
mOk.addEventListener("click", async () => {
  const pre = {
    receipt: document.getElementById("mReceipt").value,
    company: document.getElementById("mCompany").value,
    partNo: document.getElementById("mPartNo").value,
    partName: document.getElementById("mPartName").value,
    spec: document.getElementById("mSpec").value,
    symptom: document.getElementById("mSymptom").value,
    repairer: document.getElementById("mRepairer").value,
    contact: document.getElementById("mContact").value,
    note: document.getElementById("mNote").value
  };
  await addRowDoc(pre);
  closeModal();
});
mCancel.addEventListener("click", closeModal);
modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

/* ===============
   버튼 핸들러
   =============== */
btnAdd.addEventListener("click", () => addRowDoc({}));
btnDelete.addEventListener("click", () => deleteSelectedRows());
btnOpen.addEventListener("click", openModal);

/* ===============
   익명 로그인 후 실시간 시작
   =============== */
signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth, (user) => {
  if (user) startRealtime();
});
</script>
</body>
</html>
